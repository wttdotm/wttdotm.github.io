<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manhattan North Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <meta name="description" content="A map that pins true north to Manhattan's orientation.">
    <meta name="keywords" content="Manhattan, Map, North Up, New York, Compass, NYC">
    <meta name="author" content="WTTDOTM">
    <meta property="og:title" content="Manhattan North - The Way It Should Be">
    <meta property="og:description" content="Because we New Yorkers are that self-centered.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://wttdotm.com/manhattan_north/">
    <meta property="og:image" content="./link_preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Manhattan North - The Way It Should Be">
    <meta name="twitter:description" content="Because we New Yorkers are that self-centered.">
    <meta name="twitter:image" content="./link_preview.png">
    <link rel="icon" href="/assets/favicon/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/favicon/icon-192x192.png">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-29deg);
            transform-origin: center center;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Make sure the Leaflet controls (zoom, attribution) are not rotated */
        .leaflet-top,
        .leaflet-bottom {
            transform: rotate(29deg);
        }

        
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
    </div>
    <style>
        .fixed-link {
            position: fixed;
            right: 18px;
            z-index: 9999;
            text-decoration: none;
            background: rgba(255,255,255,0.92);
            color: #111;
            font-size: 15px;
            font-family: 'sans-serif', Arial, Helvetica;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            padding: 5px 24px 5px 24px;
            transition: background 0.15s;
            opacity: 0.93;
            display: inline-block;
            min-width: 162px; /* Set to the wider of the two as minimum */
            text-align: center;
        }
        .fixed-link:hover {
            background: rgba(255,255,255,1);
            box-shadow: 0 6px 22px rgba(0,0,0,0.15), 0 1.5px 4px rgba(0,0,0,0.08);
            transform: translateY(-4px) scale(1.045);
            transition: 
                background 0.15s,
                box-shadow 0.18s,
                transform 0.17s cubic-bezier(.16,.84,.44,1);
        }
        .fixed-link.toggle {
            cursor: pointer;
            user-select: none;
        }
    </style>
    <a href="./petition.pdf" target="_blank" rel="noopener"
       class="fixed-link"
       style="bottom: 106px;">
        Read the petition here
    </a>
    <a href="https://wttdotm.com" target="_blank" rel="noopener"
       class="fixed-link"
       style="bottom: 62px;">
        Project by WTTDOTM
    </a>
    <div id="manhattan-north-toggle" class="fixed-link toggle" style="bottom: 18px;">
        Manhattan North: On
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Central Park coordinates
        var centralParkLat = 40.7829;
        var centralParkLng = -73.9654;

        // Initialize the map with Central Park as center
        var map = L.map('map').setView([centralParkLat, centralParkLng], 12);

        // Load OSM tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Manhattan North toggle state (default: on)
        var manhattanNorthEnabled = true;
        var mapContainer = document.getElementById('map-container');
        var mapElement = document.getElementById('map');
        var rotationAngle = 29 * Math.PI / 180; // Unrotate by 29 degrees
        
        // Store event listener references for removal
        var eventListeners = {
            mouse: [],
            wheel: null,
            touch: []
        };

        // Transform mouse coordinates from rotated space to unrotated space
        function unrotatePoint(screenX, screenY) {
            var containerRect = mapContainer.getBoundingClientRect();
            var mapRect = mapElement.getBoundingClientRect();
            
            // Get center points
            var containerCenterX = containerRect.left + containerRect.width / 2;
            var containerCenterY = containerRect.top + containerRect.height / 2;
            var mapCenterX = mapRect.left + mapRect.width / 2;
            var mapCenterY = mapRect.top + mapRect.height / 2;
            
            // Mouse relative to container center
            var dx = screenX - containerCenterX;
            var dy = screenY - containerCenterY;
            
            // Unrotate
            var cos = Math.cos(rotationAngle);
            var sin = Math.sin(rotationAngle);
            var unrotatedX = dx * cos - dy * sin;
            var unrotatedY = dx * sin + dy * cos;
            
            // Convert to screen coordinates relative to map center
            return {
                x: mapCenterX + unrotatedX,
                y: mapCenterY + unrotatedY
            };
        }

        // Function to enable Manhattan North
        function enableManhattanNorth() {
            // Apply rotation transform
            mapContainer.style.transform = 'translate(-50%, -50%) rotate(-29deg)';
            
            // Rotate Leaflet controls back
            var controls = document.querySelectorAll('.leaflet-top, .leaflet-bottom');
            controls.forEach(function(control) {
                control.style.transform = 'rotate(29deg)';
            });
            
            // Set up event interceptors
            function interceptEvent(eventType) {
                var handler = function(e) {
                    if (e.synthetic) return;
                    var transformed = unrotatePoint(e.clientX, e.clientY);
                    var newEvent = new MouseEvent(eventType, {
                        clientX: transformed.x,
                        clientY: transformed.y,
                        button: e.button,
                        buttons: e.buttons,
                        bubbles: e.bubbles,
                        cancelable: e.cancelable,
                        view: e.view,
                        detail: e.detail,
                        screenX: e.screenX,
                        screenY: e.screenY,
                        ctrlKey: e.ctrlKey,
                        shiftKey: e.shiftKey,
                        altKey: e.altKey,
                        metaKey: e.metaKey
                    });
                    newEvent.synthetic = true;
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    mapElement.dispatchEvent(newEvent);
                };
                mapContainer.addEventListener(eventType, handler, true);
                eventListeners.mouse.push({type: eventType, handler: handler});
            }
            
            function interceptWheel() {
                var handler = function(e) {
                    if (e.synthetic) return;
                    var transformed = unrotatePoint(e.clientX, e.clientY);
                    var newEvent = new WheelEvent('wheel', {
                        clientX: transformed.x,
                        clientY: transformed.y,
                        deltaX: e.deltaX,
                        deltaY: e.deltaY,
                        deltaZ: e.deltaZ,
                        deltaMode: e.deltaMode,
                        bubbles: e.bubbles,
                        cancelable: e.cancelable,
                        view: e.view,
                        screenX: e.screenX,
                        screenY: e.screenY,
                        ctrlKey: e.ctrlKey,
                        shiftKey: e.shiftKey,
                        altKey: e.altKey,
                        metaKey: e.metaKey
                    });
                    newEvent.synthetic = true;
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    mapElement.dispatchEvent(newEvent);
                };
                mapContainer.addEventListener('wheel', handler, true);
                eventListeners.wheel = handler;
            }
            
            function interceptTouchEvent(eventType) {
                var handler = function(e) {
                    if (e.synthetic) return;
                    var originalTouches = e.touches;
                    var originalChangedTouches = e.changedTouches;
                    var transformedTouches = [];
                    for (var i = 0; i < originalTouches.length; i++) {
                        var touch = originalTouches[i];
                        var transformed = unrotatePoint(touch.clientX, touch.clientY);
                        transformedTouches.push({
                            identifier: touch.identifier,
                            target: mapElement,
                            clientX: transformed.x,
                            clientY: transformed.y,
                            screenX: touch.screenX,
                            screenY: touch.screenY,
                            pageX: transformed.x + window.scrollX,
                            pageY: transformed.y + window.scrollY,
                            radiusX: touch.radiusX || 0,
                            radiusY: touch.radiusY || 0,
                            rotationAngle: touch.rotationAngle || 0,
                            force: touch.force || 0
                        });
                    }
                    var transformedChangedTouches = [];
                    for (var i = 0; i < originalChangedTouches.length; i++) {
                        var touch = originalChangedTouches[i];
                        var transformed = unrotatePoint(touch.clientX, touch.clientY);
                        transformedChangedTouches.push({
                            identifier: touch.identifier,
                            target: mapElement,
                            clientX: transformed.x,
                            clientY: transformed.y,
                            screenX: touch.screenX,
                            screenY: touch.screenY,
                            pageX: transformed.x + window.scrollX,
                            pageY: transformed.y + window.scrollY,
                            radiusX: touch.radiusX || 0,
                            radiusY: touch.radiusY || 0,
                            rotationAngle: touch.rotationAngle || 0,
                            force: touch.force || 0
                        });
                    }
                    try {
                        Object.defineProperty(e, 'touches', {
                            get: function() { return transformedTouches; },
                            configurable: true
                        });
                        Object.defineProperty(e, 'changedTouches', {
                            get: function() { return transformedChangedTouches; },
                            configurable: true
                        });
                        Object.defineProperty(e, 'targetTouches', {
                            get: function() { return transformedTouches; },
                            configurable: true
                        });
                        e.synthetic = true;
                    } catch(err) {
                        e.stopImmediatePropagation();
                        e.preventDefault();
                        var customEvent = new CustomEvent(eventType, {
                            bubbles: true,
                            cancelable: true,
                            detail: {
                                touches: transformedTouches,
                                changedTouches: transformedChangedTouches
                            }
                        });
                        customEvent.touches = transformedTouches;
                        customEvent.changedTouches = transformedChangedTouches;
                        customEvent.targetTouches = transformedTouches;
                        customEvent.synthetic = true;
                        mapElement.dispatchEvent(customEvent);
                        return;
                    }
                };
                mapContainer.addEventListener(eventType, handler, true);
                eventListeners.touch.push({type: eventType, handler: handler});
            }
            
            ['mousedown', 'mousemove', 'mouseup', 'click', 'dblclick'].forEach(interceptEvent);
            interceptWheel();
            ['touchstart', 'touchmove', 'touchend', 'touchcancel'].forEach(interceptTouchEvent);
        }
        
        // Function to disable Manhattan North
        function disableManhattanNorth() {
            // Remove rotation transform
            mapContainer.style.transform = 'translate(-50%, -50%)';
            
            // Remove rotation from Leaflet controls
            var controls = document.querySelectorAll('.leaflet-top, .leaflet-bottom');
            controls.forEach(function(control) {
                control.style.transform = '';
            });
            
            // Remove all event listeners
            eventListeners.mouse.forEach(function(listener) {
                mapContainer.removeEventListener(listener.type, listener.handler, true);
            });
            eventListeners.mouse = [];
            
            if (eventListeners.wheel) {
                mapContainer.removeEventListener('wheel', eventListeners.wheel, true);
                eventListeners.wheel = null;
            }
            
            eventListeners.touch.forEach(function(listener) {
                mapContainer.removeEventListener(listener.type, listener.handler, true);
            });
            eventListeners.touch = [];
        }

        // Function to calculate and set container size/position
        function updateMapLayout() {
            var vw = window.innerWidth;
            var vh = window.innerHeight;
            
            if (manhattanNorthEnabled) {
                // Calculate for rotated map
                var rotationRad = 29 * Math.PI / 180;
                var cos = Math.abs(Math.cos(rotationRad));
                var sin = Math.abs(Math.sin(rotationRad));
                var cosPlusSin = cos + sin;
                var minSize = Math.max(vw, vh) / cosPlusSin;
                var isMobile = window.innerWidth < 768;
                var safetyMargin = isMobile ? 2.0 : 3.0;
                var containerSize = minSize * safetyMargin;
                mapContainer.style.width = containerSize + 'px';
                mapContainer.style.height = containerSize + 'px';
            } else {
                // Normal map - just cover viewport
                var containerSize = Math.max(vw, vh) * 1.2;
                mapContainer.style.width = containerSize + 'px';
                mapContainer.style.height = containerSize + 'px';
            }
            
            // Trigger resize event so Leaflet recalculates tile positions
            map.invalidateSize();
            
            // Wait a tick for the size to be updated, then center on Central Park
            setTimeout(function() {
                var currentZoom = map.getZoom() || 12;
                map.setView([centralParkLat, centralParkLng], currentZoom, { animate: false });
            }, 0);
        }
        
        // Toggle button handler
        var toggleButton = document.getElementById('manhattan-north-toggle');
        toggleButton.addEventListener('click', function() {
            manhattanNorthEnabled = !manhattanNorthEnabled;
            
            if (manhattanNorthEnabled) {
                enableManhattanNorth();
                toggleButton.textContent = 'Manhattan North: On';
            } else {
                disableManhattanNorth();
                toggleButton.textContent = 'Manhattan North: Off';
            }
            
            updateMapLayout();
        });

        // Wait for map to be ready before setting up layout
        map.whenReady(function() {
            // Enable Manhattan North by default
            enableManhattanNorth();
            toggleButton.textContent = 'Manhattan North: On';
            
            // Initial layout setup
            updateMapLayout();
            
            // Set up resize handler
            window.addEventListener('resize', updateMapLayout);
        });

        // Also handle window load in case map is ready before window loads
        if (document.readyState === 'complete') {
            // Map might already be ready, but updateMapLayout will handle it
        } else {
            window.addEventListener('load', function() {
                if (map._loaded) {
                    updateMapLayout();
                }
            });
        }
    </script>
     <img style="position: absolute; bottom: 1px; left: 0px; z-index: 8; max-height: 150px; max-width: 150px;" src="./manhattanNorthIcon.png"/>
</body>
</html>
